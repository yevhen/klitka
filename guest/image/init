#!/bin/sh
set -eu

CONSOLE="/dev/console"
if [ ! -c "${CONSOLE}" ]; then
  if [ -c /dev/ttyAMA0 ]; then
    CONSOLE="/dev/ttyAMA0"
  elif [ -c /dev/ttyS0 ]; then
    CONSOLE="/dev/ttyS0"
  else
    CONSOLE=""
  fi
fi

log() {
  if [ -n "${CONSOLE}" ]; then
    printf "%s\n" "$*" > "${CONSOLE}" 2>/dev/null || printf "%s\n" "$*"
  else
    printf "%s\n" "$*"
  fi
}

log_cmd() {
  if [ -n "${CONSOLE}" ]; then
    "$@" > "${CONSOLE}" 2>&1 || "$@" || true
  else
    "$@" || true
  fi
}

mount -t proc proc /proc || log "[init] mount proc failed"
mount -t sysfs sysfs /sys || log "[init] mount sysfs failed"
mount -t devtmpfs devtmpfs /dev || log "[init] mount devtmpfs failed"

mkdir -p /dev/pts /dev/shm /run
mount -t devpts devpts /dev/pts || log "[init] mount devpts failed"
mount -t tmpfs tmpfs /run || log "[init] mount tmpfs failed"

export PATH=/usr/sbin:/usr/bin:/sbin:/bin

mkdir -p /tmp /var/tmp /var/cache /var/log /root /home
mount -t tmpfs tmpfs /tmp || log "[init] mount tmpfs /tmp failed"
mount -t tmpfs tmpfs /root || log "[init] mount tmpfs /root failed"
mount -t tmpfs tmpfs /var/tmp || log "[init] mount tmpfs /var/tmp failed"
mount -t tmpfs tmpfs /var/cache || log "[init] mount tmpfs /var/cache failed"
mount -t tmpfs tmpfs /var/log || log "[init] mount tmpfs /var/log failed"

mkdir -p /tmp/.cache /tmp/.config /tmp/.local/share

export HOME=/root
export TMPDIR=/tmp
export XDG_CACHE_HOME=/tmp/.cache
export XDG_CONFIG_HOME=/tmp/.config
export XDG_DATA_HOME=/tmp/.local/share
export UV_CACHE_DIR=/tmp/.cache/uv
export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
export UV_NATIVE_TLS=true

log "[init] /dev entries:"
log_cmd ls -l /dev
if [ -d /dev/virtio-ports ]; then
  log "[init] /dev/virtio-ports:"
  log_cmd ls -l /dev/virtio-ports
else
  log "[init] /dev/virtio-ports missing"
fi
if [ -d /sys/class/virtio-ports ]; then
  log "[init] /sys/class/virtio-ports:"
  log_cmd ls -l /sys/class/virtio-ports
else
  log "[init] /sys/class/virtio-ports missing"
fi

if modprobe virtio > /dev/null 2>&1; then
  log "[init] loaded virtio"
fi
if modprobe virtio_ring > /dev/null 2>&1; then
  log "[init] loaded virtio_ring"
fi
if modprobe virtio_console > /dev/null 2>&1; then
  log "[init] loaded virtio_console"
fi
if modprobe virtio_rng > /dev/null 2>&1; then
  log "[init] loaded virtio_rng"
fi
if [ -e /dev/hwrng ]; then
  log "[init] starting rngd"
  rngd -r /dev/hwrng -o /dev/random > /dev/null 2>&1 &
else
  log "[init] /dev/hwrng missing"
fi

if modprobe virtio_pci > /dev/null 2>&1; then
  log "[init] loaded virtio_pci"
fi
if modprobe virtio_mmio > /dev/null 2>&1; then
  log "[init] loaded virtio_mmio"
fi
if modprobe virtio_net > /dev/null 2>&1; then
  log "[init] loaded virtio_net"
fi

if command -v ip > /dev/null 2>&1; then
  ip link set eth0 up || true
else
  ifconfig eth0 up || true
fi

if command -v udhcpc > /dev/null 2>&1; then
  UDHCPC_SCRIPT="/usr/share/udhcpc/default.script"
  if [ ! -x "${UDHCPC_SCRIPT}" ]; then
    UDHCPC_SCRIPT="/sbin/udhcpc.script"
  fi
  if [ -x "${UDHCPC_SCRIPT}" ]; then
    udhcpc -i eth0 -q -n -s "${UDHCPC_SCRIPT}" || log "[init] udhcpc failed"
  else
    udhcpc -i eth0 -q -n || log "[init] udhcpc failed"
  fi
fi

if modprobe virtiofs > /dev/null 2>&1 || modprobe virtio_fs > /dev/null 2>&1; then
  log "[init] loaded virtiofs"
fi

mount_specs=""
if [ -r /proc/cmdline ]; then
  for arg in $(cat /proc/cmdline); do
    case "${arg}" in
      klitkavm.mount=*)
        mount_specs="${mount_specs} ${arg#klitkavm.mount=}"
        ;;
    esac
  done
fi

mount_virtiofs() {
  spec="$1"
  tag="${spec%%:*}"
  rest="${spec#*:}"
  path="${rest%%:*}"
  mode="${rest#*:}"
  if [ "${rest}" = "${path}" ]; then
    mode="rw"
  fi

  if [ -z "${tag}" ] || [ -z "${path}" ]; then
    log "[init] invalid mount spec: ${spec}"
    return
  fi

  mkdir -p "${path}"
  opts=""
  if [ "${mode}" = "ro" ]; then
    opts="-o ro"
  fi

  log "[init] mounting virtiofs ${tag} -> ${path} (${mode})"
  mount -t virtiofs ${opts} "${tag}" "${path}" || log "[init] virtiofs mount failed for ${tag}"
}

if [ -n "${mount_specs}" ]; then
  for spec in ${mount_specs}; do
    mount_virtiofs "${spec}"
  done
fi

if [ -f /run/klitkavm/mitm-ca.crt ]; then
  log "[init] installing mitm ca"
  install -d /usr/local/share/ca-certificates || true
  cp /run/klitkavm/mitm-ca.crt /usr/local/share/ca-certificates/klitkavm-mitm-ca.crt || true
  if [ -f /etc/ssl/certs/ca-certificates.crt ]; then
    cat /run/klitkavm/mitm-ca.crt >> /etc/ssl/certs/ca-certificates.crt || true
  fi
fi

log "[init] starting sandboxd"

exec /usr/bin/sandboxd
