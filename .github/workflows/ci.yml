name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      KLITKA_DEBUG_QEMU: "1"
      KLITKA_DEBUG_CONN: "1"
      KLITKA_FS_BACKEND: "auto"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Build guest assets
        run: |
          nix develop --command bash -c "./scripts/build-guest-assets.sh"

      - name: Run Go tests
        run: |
          nix develop --command bash -c "go test ./..."

      - name: Run SDK tests
        run: |
          nix develop --command bash -c "cd sdk && npm test"

      - name: Setup Go (for GoReleaser)
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Run GoReleaser snapshot
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --snapshot --clean --skip-publish

      - name: Smoke test archive
        run: |
          nix develop --command bash -c "./scripts/smoke-archive.sh"

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
          if-no-files-found: error

  test-windows:
    runs-on: windows-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Ensure WSL2 distro
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $distros = wsl -l -q 2>$null
          if (-not $distros) {
            Write-Host "No WSL distro found; importing Ubuntu."
            $rootfs = "$env:RUNNER_TEMP\ubuntu.rootfs.tar.gz"
            Invoke-WebRequest -Uri "https://cloud-images.ubuntu.com/wsl/jammy/current/ubuntu-jammy-wsl-amd64-wsl.rootfs.tar.gz" -OutFile $rootfs
            $distroPath = "$env:RUNNER_TEMP\wsl\Ubuntu"
            New-Item -ItemType Directory -Force -Path $distroPath | Out-Null
            wsl --import Ubuntu $distroPath $rootfs --version 2
          }
          wsl -l -v

      - name: Install WSL2 dependencies
        shell: powershell
        run: |
          wsl -d Ubuntu -u root --exec bash -lc "apt-get update"
          wsl -d Ubuntu -u root --exec bash -lc "apt-get install -y curl ca-certificates qemu-system-x86 python3 cpio gzip xz-utils make golang-go"
          wsl -d Ubuntu -u root --exec bash -lc "if ! command -v zig >/dev/null; then ZIG_VERSION=0.12.0; curl -L https://ziglang.org/download/$ZIG_VERSION/zig-linux-x86_64-$ZIG_VERSION.tar.xz -o /tmp/zig.tar.xz; mkdir -p /opt/zig; tar -C /opt/zig -xf /tmp/zig.tar.xz --strip-components=1; ln -sf /opt/zig/zig /usr/local/bin/zig; fi"

      - name: Run WSL2 smoke test
        shell: powershell
        env:
          KLITKA_WSL_DISTRO: Ubuntu
        run: |
          go test ./...

      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Smoke test release archive
        shell: powershell
        env:
          KLITKA_WSL_DISTRO: Ubuntu
        run: |
          ./scripts/smoke-archive.ps1

  smoke-macos:
    runs-on: macos-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Smoke test archive
        run: |
          nix develop --command bash -c "./scripts/smoke-archive.sh"
